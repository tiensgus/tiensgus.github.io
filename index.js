//--menu unit
let listUrlYt = [
    "",    
    "https://youtu.be/Xj8Amv0Z52w?si=N7RCH2QWFryI2os8",
    "https://youtu.be/lfEy2xMmv0Y?si=XbVE7st0EsCahPaM",
    "https://youtu.be/ltKWFehkvVU?si=89YOlYywQw9GyVQR",
    "https://youtu.be/Zb6isCtPnEI?si=W0m_A7Sa0VAuSucR",
    "https://youtu.be/dDCfehYsrgk?si=O5SJta58aaOnuDAd",
    "https://youtu.be/vr9iQtbb6I8?si=p-fNncDUKp14lPks",
    "https://youtu.be/TLDAAk_lpyY?si=krQJdz1dXYS_9N4e",
    "https://youtu.be/C2amKJcCSFU?si=b8B0EWEdQradSZol",
    "https://youtu.be/qO8aWZ-sfTI?si=iBV4_3PcBGGovCaw",
    "https://youtu.be/K2O-8dSTmGM?si=DSEkSzg8Vio_t_Zn",
    "https://youtu.be/GOa65ir00m8?si=ah7EGu_S8p087sqR",
    
    "https://youtu.be/rvavpRuzHfY?si=VohF584qqKUy_ne1",
    "https://youtu.be/BlM-Syj6bP0?si=UhE7LKIaHNc-40TW",
    "https://youtu.be/Bjc6UI5YgDQ?si=6KhZraOa93lWanfm",
    "https://youtu.be/G1pQ1E7pYHw?si=b-zpv5KozlH5aGTy",
    "https://youtu.be/hA8HdVq3fNc?si=98-EBJpRaBXn8-TR",
    "https://youtu.be/djNclWnIvHw?si=08hIcMU1BZsrdttO",
    "https://youtu.be/vXrLxdliCiw?si=lPEqPhCWWwI5YVJ6",
    "https://youtu.be/pxLEhCufVPc?si=Ori4PlnwWzs9tkr8",
    "https://youtu.be/VMhPHWI7yvQ?si=D3QWpX99GXjAjP57",
    "https://youtu.be/hUJDSGI64pQ?si=mzckx8TcJGojLc9z",
    "https://youtu.be/iPKQCpZJTvw?si=Mk8CK9HxMjzwDtFj",
    "https://youtu.be/58geqDklMLU?si=wtFIcM-7tqgoR6cN",
    "https://youtu.be/XUIOdZj5Ni4?si=KD9ukiYJBvD8hXiT",
    "https://youtu.be/CXYoUA37Xas?si=KqE_YPkoDSiJJ_ir",
    
    "https://youtu.be/mreFzGaKLpY?si=0karBzNpkwubwRQP",
    "https://youtu.be/85GZKHYwJ1A?si=_UpY-sO_4rfupXa_",
    "https://youtu.be/M6XIzsOTdQQ?si=2kf64eY8gAdPKiC9",
    "https://youtu.be/kNZKCk6WPEo?si=XXlL5v0w5mHE-Mhd",
    "https://youtu.be/grllLeqd8pw?si=N60TGISSZdJ1c382",
    "https://youtu.be/CPGoFenijc4?si=I3vVxgdAmO4-JJwD",
    "https://youtu.be/jfztr4grDuw?si=t2jBTEEuXZUsZAwo",
    "https://youtu.be/VjnxaTriZM0?si=RMjUuAR6oFXa-T-Z",
    "https://youtu.be/6wXRxUa4wyU?si=3QcGJoxFaWIWlNUD",
    "https://youtu.be/f-Qx2UhtSEY?si=SbttDKOM9gTfZsGq",
    "https://youtu.be/DqHu21-GwBc?si=SqirGuYUBUg6wJi8",
    "https://youtu.be/YYoa2yVGymM?si=ZmIOIAhR6bafwsjm",
    "https://youtu.be/ObNoRKjfYxo?si=S9Sne-ajXasgyIMa",
    "https://youtu.be/ULo3ZCbK474?si=pWcOqBFC9Cb2Ssdp",
    "https://youtu.be/Dme7NDF-Big?si=m5cKbxaiVugUmX4C",
    "https://youtu.be/T_P6kqCQjb0?si=G1G6Obd6QorKwRL5",
    "https://youtu.be/Lpn3vGsN4bc?si=JGLLXsCdLAsPbbrn",
    "https://youtu.be/Sr9HGGU0AP4?si=wdmoj1K6Bzpc6OmD",
    "https://youtu.be/PpBNHLJ_Bdc?si=R-KD5hLNq6ALvkZc",
    "https://youtu.be/wWUTbBJnSrw?si=Q8WOHPxGwbkzsdzW",
    "https://youtu.be/6DCcF5iq9eY?si=35nznnFCrwkvOnSF",
    "https://youtu.be/MqT42QVxPV0?si=9UTJSjIzJBE4tuLP",
    "https://youtu.be/Qnj8j4Y1CIk?si=NFwDeW_nhLI9CVpG",
    "https://youtu.be/M7NHT21Udfo?si=_7eDTYcDjH9tMirK",
    
    "https://youtu.be/vG7bD1V1vYM?si=vcWo1GmILTMLhW25",
    "https://youtu.be/PBpCh6ZOOYA?si=wQEyNTFB5cxqxmO3",
    "https://youtu.be/jOHp6EqEJz0?si=Z3VZUCHMqHc59myV",
    "https://youtu.be/gXk71msBMgo?si=T2oq74NbA-AHYXjt",
    "https://youtu.be/ff3VrHmFirs?si=40PXpqNt78n3X1M_",
    "https://youtu.be/ZKb2zpoEKbg?si=T0wArJBDozwTqJDX",
    "https://youtu.be/CXWlHOjTMBM?si=GwMBw6c1rr4-yktH",
    "https://youtu.be/nz0VIbZUpPI?si=fWQDq8XH5EpaByuC",
    "https://youtu.be/2p6LN506wN0?si=foRYxUz35nc9xHsl",
    "https://youtu.be/94p8nPfEdu0?si=-1SsBYSTYU_6HkEy",
    "https://youtu.be/HPUu7Eu5bdo?si=7nLdefi_sZPFMrC_",
    "https://youtu.be/B_Fh21CwXi0?si=JNYK5_8r3HMz9_gW",
    "https://youtu.be/pjdRa8-4QCE?si=MpW76qkWuTvo2adm",
    "https://youtu.be/Mt8LcfwkfDc?si=Fxe8Hn4aS0f__HBR",
    "https://youtu.be/ZqqsH2jSxEo?si=MAOorfabrMt7JadW",
    "https://youtu.be/l92O_ie7T7o?si=3mnsM6_P7cAZ0NIx",
    "https://youtu.be/1PpuwIWJ_AU?si=Ds44pSmard2VNuAA",
    "https://youtu.be/BN1g_G_ATGc?si=0xclFCyknbaje-Bl",
    "https://youtu.be/W3vY8AB4YxQ?si=gvvU7Xk5sY_eD6Gu",
    "https://youtu.be/mkWhUuveuCo?si=B0GVbfyqlj9lPzQ-",
    "https://youtu.be/PjNfRrbSu-E?si=lniJIkM4ARXVradL",
    "https://youtu.be/toEv7eDDxPE?si=3hoJGt0Qzb_XvIzo",
    "https://youtu.be/NkJjcGoum-U?si=qlkjRDzGXgEAi41E",
    "https://youtu.be/qaFcCN23JiQ?si=VyTTQXB3NgXRC3dO",
    "https://youtu.be/sk=proj=epXwjLAeKPLBuTFMvjDmdQAhDVbhKcSZJ60xkDI4iF419uvhXC7GZ7jS7CHl8=OCemM293KtU5T3BlbkFJJ14i4QAWBYiJQbPMNBOMtspp8QL==mVbG2uig2oq44YGtjW9TFb3DdQuIrKYm7kNvvTnUqKoUA"];
    
    let list_id = ["", 
        'Xj8Amv0Z52w', 'lfEy2xMmv0Y', 'ltKWFehkvVU', 'Zb6isCtPnEI', 'dDCfehYsrgk', 'vr9iQtbb6I8', 
        'TLDAAk_lpyY', 'C2amKJcCSFU', 'qO8aWZ-sfTI', 'K2O-8dSTmGM', 'GOa65ir00m8', 'BlM-Syj6bP0',
        'Bjc6UI5YgDQ', 'G1pQ1E7pYHw', 'hA8HdVq3fNc', 'djNclWnIvHw', 'vXrLxdliCiw', 'pxLEhCufVPc', 
        'VMhPHWI7yvQ', 'hUJDSGI64pQ', 'iPKQCpZJTvw', '58geqDklMLU', 'XUIOdZj5Ni4', 'CXYoUA37Xas', 
        'mreFzGaKLpY', '85GZKHYwJ1A', 'M6XIzsOTdQQ', 'kNZKCk6WPEo', 'grllLeqd8pw', 'CPGoFenijc4', 
        'jfztr4grDuw', 'VjnxaTriZM0', '6wXRxUa4wyU', 'f-Qx2UhtSEY', 'DqHu21-GwBc', 'YYoa2yVGymM', 
        'ObNoRKjfYxo', 'ULo3ZCbK474', 'Dme7NDF-Big', 'T_P6kqCQjb0', 'Lpn3vGsN4bc', 'Sr9HGGU0AP4', 
        'PpBNHLJ_Bdc', 'wWUTbBJnSrw', '6DCcF5iq9eY', 'MqT42QVxPV0', 'Qnj8j4Y1CIk', 'M7NHT21Udfo', 
        'vG7bD1V1vYM', 'PBpCh6ZOOYA', 'jOHp6EqEJz0', 'gXk71msBMgo', 'ff3VrHmFirs', 'ZKb2zpoEKbg', 
        'CXWlHOjTMBM', 'nz0VIbZUpPI', '2p6LN506wN0', '94p8nPfEdu0', 'HPUu7Eu5bdo', 'B_Fh21CwXi0', 
        'pjdRa8-4QCE', 'Mt8LcfwkfDc', 'ZqqsH2jSxEo', 'l92O_ie7T7o', '1PpuwIWJ_AU', 'BN1g_G_ATGc', 
        'W3vY8AB4YxQ', 'mkWhUuveuCo', 'PjNfRrbSu-E', 'toEv7eDDxPE', 'NkJjcGoum-U', 'qaFcCN23JiQ'];
    
    
    let listMenuSelect = [
        'Basic Unit 1 : Introductions and Names', 
        'Basic Unit 2 : Describing people', 
        'Basic Unit 3 : Clothes', 
        'Basic Unit 4 : Routines', 
        'Basic Unit 5 : Dates', 
        'Basic Unit 6 : Jobs', 
        'Basic Unit 7 : Favorites', 
        'Basic Unit 8 : Sports and Excercise', 
        'Basic Unit 9 : Locations', 
        'Basic Unit 10 : The family', 
        'Basic Unit 11 : Entertainment', 
        'Basic Unit 12 : Prices', 
        'Basic Unit 13 : Restaurants', 
        'Basic Unit 14 : Small Talk', 
        'Basic Unit 15 : Vacations', 
        'Basic Unit 16 : Apartment Living', 
        'Basic Unit 17 : Hopes and Plans', 
        'Basic Unit 18 : The Weather', 
        'Basic Unit 19 : Shopping', 
        'Basic Unit 20 : Describing Things', 
        'Basic Unit 21 : Direction', 
        'Basic Unit 22 : People We Know', 
        'Basic Unit 23 : Places', 
        'Basic Unit 24 : Health', 
        'Developing Unit 1 : The Weekend', 
        'Developing Unit 2 : City Transportation', 
        'Developing Unit 3 : Neighbors', 
        'Developing Unit 4 : Celebrations', 
        'Developing Unit 5 : Restaurants', 
        'Developing Unit 6 : Gifts', 
        'Developing Unit 7 : Air Travel', 
        'Developing Unit 8 : Mishaps', 
        'Developing Unit 9 : Jobs', 
        'Developing Unit 10 : Keeping Fit', 
        'Developing Unit 11 : Invitations', 
        'Developing Unit 12 : Campus Life', 
        'Developing Unit 13 : Hobbies & Pastimes', 
        'Developing Unit 14 : Shopping Problems', 
        'Developing Unit 15 : Hotel Services', 
        'Developing Unit 16 : Movies', 
        'Developing Unit 17 : Fears', 
        'Developing Unit 18 : Phone Messages', 
        'Developing Unit 19 : Touring a City', 
        'Developing Unit 20 : Airports', 
        'Developing Unit 21 : Hotels', 
        'Developing Unit 22 : Traffic', 
        'Developing Unit 23 : Roommates', 
        'Developing Unit 24 : Travel', 
        'Expanding Unit 1 : Small Talk', 
        'Expanding Unit 2 : Plans', 
        'Expanding Unit 3 : Successful Businesses', 
        'Expanding Unit 4 : Apologies and Excuses', 
        'Expanding Unit 5 : Character Traits', 
        'Expanding Unit 6 : Travel', 
        'Expanding Unit 7 : Housing', 
        'Expanding Unit 8 : Can you believe it', 
        'Expanding Unit 9 : Friendship', 
        'Expanding Unit 10 : Television', 
        'Expanding Unit 11 : Cities', 
        'Expanding Unit 12 : Urban Life', 
        'Expanding Unit 13 : Special Days', 
        'Expanding Unit 14 : Fashion', 
        'Expanding Unit 15 : Favorites', 
        'Expanding Unit 16 : Phone Message', 
        'Expanding Unit 17 : Past Events', 
        'Expanding Unit 18 : Vacations', 
        'Expanding Unit 19 : The News', 
        'Expanding Unit 20 : Opinions', 
        'Expanding Unit 21 : Famous People', 
        'Expanding Unit 22 : Food and Nutrition', 
        'Expanding Unit 23 : Predicaments', 
        'Expanding Unit 24 : Global Issues'];
    
    let elmts = ['Basic Unit 1 : Introductions and Names', 
    'Basic Unit 2 : Describing people', 
    'Basic Unit 3 : Clothes', 
    'Basic Unit 4 : Routines', 
    'Basic Unit 5 : Dates', 
    'Basic Unit 6 : Jobs', 
    'Basic Unit 7 : Favorites', 
    'Basic Unit 8 : Sports and Excercise', 
    'Basic Unit 9 : Locations', 
    'Basic Unit 10 : The family', 
    'Basic Unit 11 : Entertainment', 
    'Basic Unit 12 : Prices', 
    'Basic Unit 13 : Restaurants', 
    'Basic Unit 14 : Small Talk', 
    'Basic Unit 15 : Vacations', 
    'Basic Unit 16 : Apartment Living', 
    'Basic Unit 17 : Hopes and Plans', 
    'Basic Unit 18 : The Weather', 
    'Basic Unit 19 : Shopping', 
    'Basic Unit 20 : Describing Things', 
    'Basic Unit 21 : Direction', 
    'Basic Unit 22 : People We Know', 
    'Basic Unit 23 : Places', 
    'Basic Unit 24 : Health', 
    'Developing Unit 1 : The Weekend', 
    'Developing Unit 2 : City Transportation', 
    'Developing Unit 3 : Neighbors', 
    'Developing Unit 4 : Celebrations', 
    'Developing Unit 5 : Restaurants', 
    'Developing Unit 6 : Gifts', 
    'Developing Unit 7 : Air Travel', 
    'Developing Unit 8 : Mishaps', 
    'Developing Unit 9 : Jobs', 
    'Developing Unit 10 : Keeping Fit', 
    'Developing Unit 11 : Invitations', 
    'Developing Unit 12 : Campus Life', 
    'Developing Unit 13 : Hobbies & Pastimes', 
    'Developing Unit 14 : Shopping Problems', 
    'Developing Unit 15 : Hotel Services', 
    'Developing Unit 16 : Movies', 
    'Developing Unit 17 : Fears', 
    'Developing Unit 18 : Phone Messages', 
    'Developing Unit 19 : Touring a City', 
    'Developing Unit 20 : Airports', 
    'Developing Unit 21 : Hotels', 
    'Developing Unit 22 : Traffic', 
    'Developing Unit 23 : Roommates', 
    'Developing Unit 24 : Travel', 
    'Expanding Unit 1 : Small Talk', 
    'Expanding Unit 2 : Plans', 
    'Expanding Unit 3 : Successful Businesses', 
    'Expanding Unit 4 : Apologies and Excuses', 
    'Expanding Unit 5 : Character Traits', 
    'Expanding Unit 6 : Travel', 
    'Expanding Unit 7 : Housing', 
    'Expanding Unit 8 : Can you believe it', 
    'Expanding Unit 9 : Friendship', 
    'Expanding Unit 10 : Television', 
    'Expanding Unit 11 : Cities', 
    'Expanding Unit 12 : Urban Life', 
    'Expanding Unit 13 : Special Days', 
    'Expanding Unit 14 : Fashion', 
    'Expanding Unit 15 : Favorites', 
    'Expanding Unit 16 : Phone Message', 
    'Expanding Unit 17 : Past Events', 
    'Expanding Unit 18 : Vacations', 
    'Expanding Unit 19 : The News', 
    'Expanding Unit 20 : Opinions', 
    'Expanding Unit 21 : Famous People', 
    'Expanding Unit 22 : Food and Nutrition', 
    'Expanding Unit 23 : Predicaments', 
    'Expanding Unit 24 : Global Issues'];
    
    // Main function
    function GFG_Fun() {
        for (let i = 0; i < elmts.length; i++) {
            let optn = elmts[i];
            let el = document.createElement("option");
            el.textContent = optn;
            el.value = optn;
            selectb.appendChild(el);
        }
    }
    GFG_Fun();

//-apiKey--chat--------------------------------------------    
var apiKey="";

//document.addEventListener("DOMContentLoaded", async () => {
//    try {
//        const response = await fetch("/api/env");
//        const data = await response.json();
//        //document.getElementById("env-value").textContent = data.envValue;
//        apiKey =  data.envValue;
//    } catch (error) {
//        console.error("Lỗi khi tải biến môi trường:", error);
        //document.getElementById("env-value").textContent = "Lỗi khi tải dữ liệu.";
//    }
//});

//--chatgpt-----------------------------
var text='';
async function sendMessage(transcript) {
    let userInput = transcript;
    //alert(userInput);
    if (!userInput) return;
    //let chatbox = document.getElementById("chatbox");
    //chatbox.innerHTML += `<p><strong>Bạn:</strong> ${userInput}</p>`;
  
    // Gửi tin nhắn đến OpenAI API
    let response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model: "gpt-4o-mini",
        messages: [{ role: "user", content: userInput }]
      })
    });
  
    let data = await response.json();
    let reply = data.choices[0].message.content;
    resultsdich.textContent = reply;
    
    function speakText(text) {
      // stop any speaking in progress
      window.speechSynthesis.cancel();
    
      // create new utterance with all the properties
      //const text = textEl.value;
      utterance = new SpeechSynthesisUtterance(text);
      utterance.voice = window.speechSynthesis.getVoices().find(voice => voice.voiceURI === voiceInEl.value);
      utterance.pitch = pitchInEl.value;
      utterance.rate = rateInEl.value;
      //utterance.volume = volumeInEl.value;
      utterance.volume = 1;
      // speak that utterance
      window.speechSynthesis.speak(utterance);
    }
    speakText(reply);
}

function reSpeak(){
  window.speechSynthesis.cancel();
  text = resultsdich.textContent;
  utterance = new SpeechSynthesisUtterance(text);
  // create new utterance with all the properties
  utterance.voice = window.speechSynthesis.getVoices().find(voice => voice.voiceURI === voiceInEl.value);
  utterance.pitch = pitchInEl.value;
  utterance.rate = rateInEl.value;
  //utterance.volume = volumeInEl.value;
  utterance.volume = 1;
  // speak that utterance
  window.speechSynthesis.speak(utterance);
}


function aboutapp(){
    var dong1 = "- Bộ sách 'Tactics for lístening' của Jack C. Richards do Đại học Oxford  phát hành, được rất nhiều người dùng .\n";
    var dong2 = "- tiensg89@gmail.com tìm thấy trên mạng nên góp nhặt tải về và lập trang web này để thuận tiện sử dụng và giúp người khác trong việc tự học nghe tiếng Anh.\n";
    var dong3 = "- Nó có 3 cuốn, mỗi cuốn có 24 unit kèm theo audio để nghe. Sách có dạng 'pdf flip' rất hay.\n";
    var dong4 = "- Cách sử dụng để học là do người dùng tự khám phá và hoạch định. Bộ tài liệu nảy rất tuyệt.";
    alert(dong1+dong2+dong3+dong4);
}


//--Cac bien toan cuc--
var text='';
var demah=0;
var messages = {//kieu dic
"start": {
  msg: 'Click on the microphone icon and begin speaking.',
  class: 'alert-success'},
"speak_now": {
  msg: 'Speak now.',
  class: 'alert-success'},
"no_speech": {
  msg: 'No speech was detected. You may need to adjust your <a href="//support.google.com/chrome/answer/2693767" target="_blank">microphone settings</a>.',
  class: 'alert-danger'},
"no_microphone": {
  msg: 'No microphone was found. Ensure that a microphone is installed and that <a href="//support.google.com/chrome/answer/2693767" target="_blank">microphone settings</a> are configured correctly.',
  class: 'alert-danger'},
"allow": {
  msg: 'Click the "Allow" button above to enable your microphone.',
  class: 'alert-warning'},
"denied": {
  msg: 'Permission to use microphone was denied.',
  class: 'alert-danger'},
"blocked": {
  msg: 'Permission to use microphone is blocked. To change, go to chrome://settings/content/microphone',
  class: 'alert-danger'},
"upgrade": {
  msg: 'Web Speech API is not supported by this browser. It is only supported by <a href="//www.google.com/chrome">Chrome</a> version 25 or later on desktop and Android mobile.',
  class: 'alert-danger'},
"stop": {
    msg: 'Stop listening, click on the microphone icon to restart',
    class: 'alert-success'},
"copy": {
  msg: 'Content copy to clipboard successfully.',
  class: 'alert-success'},
}
var final_transcript = '';
var recognizing = false;
var ignore_onend;
var start_timestamp;
var recognition;

//cac ham ung voi cac su kien
$( document ).ready(function() {
if (!('webkitSpeechRecognition' in window)) {
  upgrade();
} else {
  showInfo('start'); 
  resultsdich.innerHTML=''; //khi dang chuan bi thi cai nay phai empty
  start_button.style.display = 'inline-block';
  recognition = new webkitSpeechRecognition();
  recognition.lang = 'en-US';
  //recognition.lang = 'vi-VN';

  recognition.continuous = true;
  recognition.interimResults = true;

  recognition.onstart = function() {
    recognizing = true;
    showInfo('speak_now');
    resultsdich.innerHTML=''; //khi dang chuan bi thi cai nay phai empty
    start_img.src = 'icons/mic-animation.gif';
  };

  recognition.onerror = function(event) {
    if (event.error == 'no-speech') {
      start_img.src = 'icons/mic.gif';
      showInfo('no_speech');
      resultsdich.innerHTML=''; 
      ignore_onend = true;
    }
    if (event.error == 'audio-capture') {
      start_img.src = 'icons/mic.gif';
      showInfo('no_microphone');
      resultsdich.innerHTML=''; 
      ignore_onend = true;
    }
    if (event.error == 'not-allowed') {
      resultsdich.innerHTML=''; 
      if (event.timeStamp - start_timestamp < 100) {
        showInfo('blocked');
      } else {
        showInfo('denied');
      }
      ignore_onend = true;
    }
  };

  recognition.onend = function() {
    recognizing = false;
    if (ignore_onend) {
      return;
    }
    start_img.src = 'icons/mic.gif';
    if (!final_transcript) {
      showInfo('start');
      return;
    }
    showInfo('stop');
    //translate();
  };

  recognition.onresult = function(event) {
      var interim_transcript = '';
      resultsdich.innerHTML=''; //khi dang chuan bi thi cai nay phai empty
      //chu y rang van de kq trung gian va cuoi cung hien ra cho ta thay ct dang chay
      //nhung cuoi cung thi dich moi hien ra 
      for (var i = event.resultIndex; i < event.results.length; ++i) {
          if (event.results[i].isFinal) {
              final_transcript += event.results[i][0].transcript;
          } else {
              interim_transcript += event.results[i][0].transcript; 
          }
      }
      final_transcript = capitalize(final_transcript);
      final_span.innerHTML = linebreak(final_transcript);
      interim_span.innerHTML = linebreak(interim_transcript);

      sendMessage(final_transcript);
  
    //final_transcript la global nen no van ton tai ca cac thay doi, den khi ta click nghe thi moi dich
    //resultsdich.innerHTML=translate(final_transcript);     
    //translate(final_transcript);     
  };

}
});


function upgrade() {
  start_button.style.visibility = 'hidden';
  showInfo('upgrade');
}

var two_line = /\n\n/g;
var one_line = /\n/g;
function linebreak(s) {
return s.replace(two_line, '<p></p>').replace(one_line, '<br>');
}

var first_char = /\S/;
function capitalize(s) {
return s.replace(first_char, function(m) { return m.toUpperCase(); });
}

//---Khi micro duoc click ------------
$("#start_button").click(function () {
if (recognizing) {
  recognition.stop();
  return;
}
final_transcript = '';

//recognition.lang = select_source_dialect.value;
//alert(recognition.lang); //thu cho nay thay dung roi khi nhap nut button start
recognition.start();
ignore_onend = false;
final_span.innerHTML = '';
interim_span.innerHTML = '';
start_img.src = 'icons/mic-slash.gif';
showInfo('allow');
start_timestamp = event.timeStamp;
});


function showInfo(s) {
if (s) {
  var message = messages[s];
  $("#info").html(message.msg);
  $("#info").removeClass();
  $("#info").addClass('alert');
  $("#info").addClass(message.class);
} else {
  $("#info").removeClass();
  $("#info").addClass('d-none');
}
}

//xu li pit/rate/vol ----------------------------------------------------------------------------------
//khai bao cac bien toan cuc va gan gitri dau


function updateOutputs() {//---------
// display current values of all range inputs, phoi bay gtri hien huu
pitchOutEl.textContent = pitchInEl.value;
rateOutEl.textContent = rateInEl.value;
}

// add UI event handlers, khi pit/rate/vol thay doi thi chay ham updateOutputs() o tren de lay gt moi
//pitchInEl.addEventListener('change', updateOutputs);
//rateInEl.addEventListener('change', updateOutputs);

//--------lay cua net dan vao
// grab the UI elements to work with
const textEl = document.getElementById('resultsdich');
const voiceInEl = document.getElementById('voice');
const pitchInEl = document.getElementById('pitch');
const rateInEl = document.getElementById('rate');
const pitchOutEl = document.querySelector('output[for="pitch"]');
const rateOutEl = document.querySelector('output[for="rate"]');

const speakEl = document.getElementById('listen_button');

// add UI event handlers
pitchInEl.addEventListener('change', updateOutputs);
rateInEl.addEventListener('change', updateOutputs);
speakEl.addEventListener('click', reSpeak);

// update voices immediately and whenever they are loaded
updateVoices();
window.speechSynthesis.onvoiceschanged = updateVoices;

function updateOutputs() {
  // display current values of all range inputs
  pitchOutEl.textContent = pitchInEl.value;
  rateOutEl.textContent = rateInEl.value;
}

function updateVoices() {
  // add an option for each available voice that isn't already added
  window.speechSynthesis.getVoices().forEach(voice => {
    
        const isAlreadyAdded = [...voiceInEl.options].some(option => option.value === voice.voiceURI);
        if (!isAlreadyAdded) {
            const option = new Option(voice.name, voice.voiceURI, voice.default, voice.default);
            if (option.value.search("English")>0){
                //console.log(option);
                voiceInEl.add(option);
            }    
        }
    
  });
}

